<!DOCTYPE html>

<html>
<head>
	<title>COMP 4021 Project</title>
	<meta charset="utf-8">
	<meta name="viewport" 
		  content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"> 
	<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
	<script>
		
		var timer = 180;
		var completion_time = 0;

		var monster_move_timer = 5000;
		
		var lives = 3;

		var goal_location = 2;
		var player_location = 398;

		var monster_location = [133,202,259,320,336];

		var disp = newMaze(10,7);

		// there are 399 squares in the maze
		function move_player(e) {
			e = e || window.event;
			switch(e.keyCode) {
				case 38:
					// up
					var div = $(".map").eq(0);
					div.css('background-color','red');
					if (player_location-21 >= 399) {
						var div = $(".map").eq(player_location-21);
						player_location -= 21;
						div.css('background-color','red');
						if(div.background != "black") {
							$("#player").appendTo(div);
						}
					}
					break;
				case 37:
					// left
					if (player_location-1 >= 1) {
						var div = $(".map").eq(player_location-1);
						player_location -= 1;
						div.css('background-color','red');
						if(div.background != "black") {
							$("#player").appendTo(div);
						}					
					}
					break;
				case 39:
					// right
					if (player_location+1 <= 399) {
						var div = $(".map").eq(player_location+1);
						player_location += 1;
						div.css('background-color','red');
						if(div.background != "black") {
							$("#player").appendTo(div);
						}					
					}
					break;
				case 40:
					// down
					if (player_location+1 <= 399) {
						var div = $(".map").eq(player_location+21);
						player_location += 21;
						div.css('background-color','red');
						if(div.background != "black") {
							$("#player").appendTo(div);
						}
					}
					break;
				default:
			}
		}

		function move_monster(e) {
			e = e || window.event;
			switch(e.keyCode) {
				case 38:
					// up
					if (monster_location-21 >= 399) {
						var div = $(".map").eq(monster_location-21);
						monster_location -= 21
						if(div.background != "black") {
							$("#monster").appendTo(div);
						}
					}
					break;
				case 37:
					// left
					if (monster_location-1 >= 1) {
						var div = $(".map").eq(monster_location-1);
						monster_location -= 1
						if(div.background != "black") {
							$("#monster").appendTo(div);
						}
					}
					break;
				case 39:
					// right
					if (monster_location+1 <= 399) {
						var div = $(".map").eq(monster_location+1);
						monster_location += 1
						if(div.background != "black") {
							$("#monster").appendTo(div);
						}
					}
					break;
				case 40:
					// down
					if (monster_location+1 <= 399) {
						var div = $(".map").eq(monster_location+21);
						monster_location += 21
						if(div.background != "black") {
							$("#monster").appendTo(div);
						}
					}
					break;
				default:
			}
		}

		function start() {
			$("#title").fadeOut(500);
			$("#play").show();
			$("audio")[0].play();

			
			for (var i = 0; i < disp.length; i++) {
				$('#maze > tbody').append("<tr>");
				for (var j = 0; j < disp[i].length; j++) {
					var selector = i+"-"+j;
					//$('#maze > tbody').append("<td id='"+selector+"'>&nbsp;</td>");
					$('#maze > tbody').append("<td id='"+selector+"'>*</td>");
					if (disp[i][j][0] == 0) { $('#'+selector).css('border-top', '2px solid black'); }
					if (disp[i][j][1] == 0) { $('#'+selector).css('border-right', '2px solid black'); }
					if (disp[i][j][2] == 0) { $('#'+selector).css('border-bottom', '2px solid black'); }
					if (disp[i][j][3] == 0) { $('#'+selector).css('border-left', '2px solid black'); }
				}
				$('#maze > tbody').append("</tr>");
			}

			// start and end squares
			$('#0-0').css('background-color', 'pink');
			$('#0-0').text('S');			
			$('#6-9').css('background-color', '#cfffb7');
			$('#6-9').text('T');

			setTimeout(time, 1000);
		}

		function restart() {
			$("#gameover").hide();
			$("#play").fadeIn(500);
			$("audio")[0].play();

			setTimeout(time, 1000);
		}

		function gameover() {
			$("#play").hide();
			$("#gameover").fadeIn(500);
			$("audio")[1].play();
			$("audio")[0].pause();
			$("audio")[0].currentTime = 0;
		}

		function checkGoal() {
			if (player_location == goal_location) {
				completion_time = timer;
				timer = 180;
				
				$("#play").hide();
				$("#victory").show();
			}

		}

		function time() {
			timer -= 1;
			minute = Math.floor(timer / 60);
			second = timer % 60;
			if (second < 10) {
				second = "0" + second.toString();
			}
			$("#timer").text(minute+":"+second);
			if (timer == 0) {
				timer = 180;
				$("#timer").text("3:00");
				gameover();
			}
			else {
				setTimeout(time, 1000);
			}
		}

		function newMaze(x, y) {

			// Establish variables and starting grid
			var totalCells = x*y;
			var cells = new Array();
			var unvis = new Array();
			for (var i = 0; i < y; i++) {
				cells[i] = new Array();
				unvis[i] = new Array();
				for (var j = 0; j < x; j++) {
					cells[i][j] = [0,0,0,0];
					unvis[i][j] = true;
				}
			}
			
			// Set a random position to start from
			var currentCell = [Math.floor(Math.random()*y), Math.floor(Math.random()*x)];
			var path = [currentCell];
			unvis[currentCell[0]][currentCell[1]] = false;
			var visited = 1;
			
			// Loop through all available cell positions
			while (visited < totalCells) {
				// Determine neighboring cells
				var pot = [[currentCell[0]-1, currentCell[1], 0, 2],
						[currentCell[0], currentCell[1]+1, 1, 3],
						[currentCell[0]+1, currentCell[1], 2, 0],
						[currentCell[0], currentCell[1]-1, 3, 1]];
				var neighbors = new Array();
				
				// Determine if each neighboring cell is in game grid, and whether it has already been checked
				for (var l = 0; l < 4; l++) {
					if (pot[l][0] > -1 && pot[l][0] < y && pot[l][1] > -1 && pot[l][1] < x && unvis[pot[l][0]][pot[l][1]]) { neighbors.push(pot[l]); }
				}
				
				// If at least one active neighboring cell has been found
				if (neighbors.length) {
					// Choose one of the neighbors at random
					next = neighbors[Math.floor(Math.random()*neighbors.length)];
					
					// Remove the wall between the current cell and the chosen neighboring cell
					cells[currentCell[0]][currentCell[1]][next[2]] = 1;
					cells[next[0]][next[1]][next[3]] = 1;
					
					// Mark the neighbor as visited, and set it as the current cell
					unvis[next[0]][next[1]] = false;
					visited++;
					currentCell = [next[0], next[1]];
					path.push(currentCell);
				}
				// Otherwise go back up a step and keep going
				else {
					currentCell = path.pop();
				}
			}
			return cells;
		}


		$(document).ready(function () {
			$("#play").hide();
			
			$("#startButton").on("keydown", function(e) {
				
			});
						  
			$(document).on("keydown", function(e) {
				move_player(e);
				move_monster(e);
			});
			
		});
	</script>

	<style>
	body {
		padding: 0; 
		margin: 0; 
	}

	h1 {
		font-size: 60px;
		padding: 0;
		margin: 0;
	}

	h5 {
		padding: 0;
		margin: 0;
	}

	#sidebar, #main {
		border: 2px solid black;
	}

	#sidebar {
		flex: 5;
	}
	#main { 
		background: white;
	}

	.screen {
		box-sizing: border-box;
		border:5px solid black;
		font-size: 8vh;
		text-align: center;
		width: 90vw;
		height: 90vh;
		margin: 5vh 5vw;
	}
	
	#black {
		background: grey;
	}

	#start {
		background: red
	}

	#goal {
		background: gold;
	}

	#title {
		background: yellow;
		padding-top: 25vh;
		display: block;
	}

	#play { 
		background: gray;
		display: flex;
	}

	#instructions {
		font-size: 3vh;
	}

	#gameover {
		background: red;
		display: none;
	}

	#victory {
		background: gold;
		display: none;
	}

	a {
		display:block;
		font-size: 80%;
		line-height: 7vh;
		color: black;
		background: gray;
		width: 40vh;
		height: 8vh;
		margin: 20px auto;
		text-decoration: none;
		border: 4px solid black;
		border-radius: 10px;
	}

	a:hover {
		background: red;
		display:block;
		font-size: 80%;
		line-height:7vh;
		color: black;
		text-decoration: none;
	}

	#maze {
		border-collapse: collapse;
	}

	#maze td {
		width: 20px;
		height: 20px;
	}

	.row {
		max-height: 100%;
		min-height: 100%;
	}

	table {
		min-width: 100%;
		max-height: 90%;
	}

	</style>

</head>
<body>
	<audio><source src="fireflies.mp3" type="audio/mpeg"></audio>
	<audio><source src="gameover.mp3" type="audio/mpeg"></audio>
	<div class = "screen" id = "title">
		<p id ="title_message">Maze Escape!</p>
		<a id = "startButton" href= "#" onclick="start()" >Start</a>
	</div>

	<div class = "screen" id = "play">
		<div class = "container-fluid">
			<div class = "row">
			<div class="col-8" id = "main">
				<table id="maze">
				<tbody></tbody>
				</table>
			</div>
			<div class="col-4" id = "sidebar">
				<h1>Maze Escape!</h1>
				<h5>Time Left:</h5>
				<span id = "timer"> 3:00 </span>
				<p id = "instructions">Use the Arrow Keys to control your character! Navigate your way through the maze and reach the exit before the timer runs out! Be careful! There are monsters in the maze too! Encountering a monster will cost a life, lose all three of your lives and it is gameover!</p>
			</div>
			</div>
		</div>
	</div>

	<div class = "screen" id = "gameover">
		<p id ="gameover_message">Game Over</p>
		<a id = "restartButton" href= "#" onclick="restart()">Restart</a>
	</div>
	<div class = "screen" id = "victory">
		<p id ="gameover_message">YOU WIN!</p>
		<a id = "restartButton" href= "#" onclick="restart()">Play Again</a>
	</div>

</body>
</html>
